##==-- test/Makefile.test - Common make rules Java tests -*- makefile -*--====##
#
#                     The LLVM Compiler Infrastructure
#
# This file was developed by the LLVM research group and is distributed under
# the University of Illinois Open Source License. See LICENSE.TXT for details.
#
##===----------------------------------------------------------------------===##

.PHONY: clean

clean::
	$(Verb)$(RM) -f a.out core
	$(Verb)$(RM) -rf Output/

# we don't want these files to be deleted by make, even if they are
# intermediate results
.PRECIOUS: %.linked.bc %.raw.bc %.ll %.llvm.bc

# rule to compile java sources
ifdef BUILD_JAVA_SOURCES
JAVA_SOURCES := $(wildcard *.java)
JAVA_TESTS := $(basename $(JAVA_SOURCES))
PREFIXED_JAVA_TESTS := $(addprefix Output/, $(JAVA_TESTS))
PREFIXED_CLASS_FILES := $(addsuffix .class/, $(PREFIXED_JAVA_TESTS))

$(PREFIXED_CLASS_FILES): $(addsuffix .java,$(JAVA_TESTS))
	$(Echo) Compiling $?
	$(Verb)mkdir -p Output
	$(Verb)$(JAVAC) -d Output $?
	$(Verb)touch $@

# Compiled bytecode for tests
BYTECODE := $(addsuffix .llvm.bc, $(PREFIXED_JAVA_TESTS))

# Output produced by tests
NATIVE_OUTPUT := $(addsuffix .out-nat, $(PREFIXED_JAVA_TESTS))
JIT_OUTPUT := $(addsuffix .out-jit, $(PREFIXED_JAVA_TESTS))

# Diffs of output produced by native and llvm-java runs
DIFFS := $(addsuffix .diff, $(PREFIXED_JAVA_TESTS))

# Keep the output and diffs
.PRECIOUS: %.out-nat %.out-jit %.diff

# rule to run a .class file with the jvm
%.out-nat %.err-nat: %.class
	-$(Verb)LD_LIBRARY_PATH=$(LibDir) $(JAVA) -cp Output $(notdir $*) \
		> $*.out-nat 2> $*.err-nat

# rule to run a .class file with the llvm jit
%.out-jit %.err-jit: %.llvm.bc
	-$(Verb)$(LLI) $< > $*.out-jit 2> $*.err-jit

# rule to diff test output
%.diff: %.out-nat %.err-nat %.out-jit %.err-jit
	$(Verb)diff $*.out-nat $*.out-jit > $@ \
	&& echo -n "PASS: $(notdir $*)" || echo -n "FAIL: $(notdir $*)"
	$(Verb)diff $*.err-nat $*.err-jit > /dev/null \
	&& echo "" || echo " (stderr mismatch)"

# rule to link bytecode with runtime
%.llvm %.llvm.bc: %.linked.bc $(LibDir)/libjrt.bca $(EXTRA_OBJS) $(LOPT)
	$(Echo) Linking $< with the Java runtime
	-$(Verb)$(GCCLD) -o=$*.llvm $< -L $(LLVMGCCDIR)/lib -L $(LibDir) $(EXTRA_OBJS)

# rule to make assembly from bytecode
%.dis-ll: %.bc
	$(Echo) Disassembling $<
	$(Verb)$(LDIS) -f -o=$@ $<

all-local:: $(DIFFS)

endif
