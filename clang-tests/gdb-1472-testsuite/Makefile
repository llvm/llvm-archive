host := i386-apple-darwin10
build := i386-apple-darwin10
target := i386-apple-darwin10
srcdir := $(shell pwd)/src
objdir := $(shell pwd)/obj

CCC_ADD_ARGS := -Qunused-arguments,-std-default=gnu89,-fblocks,-Wno-return-type,-Wno-unused-value,-Wno-switch-enum,-Wno-implicit-int,-Wno-incompatible-pointer-types,-Wno-switch,-Wno-shift-op-parentheses
CC_UNDER_TEST := /Developer/usr/bin/clang
CXX_UNDER_TEST := /Developer/usr/bin/clang++
CC_UNDER_TEST_FLAGS :=
CXX_UNDER_TEST_FLAGS :=

RUNTEST = $(srcdir)/dejagnu/runtest
ENV_FLAGS := \
	CCC_ADD_ARGS=$(CCC_ADD_ARGS) \
	CC_UNDER_TEST=$(CC_UNDER_TEST) \
	CXX_UNDER_TEST=$(CXX_UNDER_TEST) \
	CC_UNDER_TEST_FLAGS=$(CC_UNDER_TEST_FLAGS) \
	CXX_UNDER_TEST_FLAGS=$(CXX_UNDER_TEST_FLAGS) \

# You can override RUNTESTFLAGS to pass options to 'runtest', as in the GDB make
# check configurations.
RUNTESTFLAGS :=

TESTSUITEDIR := src

TEST_DIRECTORIES := gdb.ada gdb.ada/exec_changed gdb.ada/fixed_points \
	gdb.ada/null_record gdb.ada/packed_array gdb.ada/start gdb.apple \
	gdb.apple/cfm-libs gdb.apple/debug-in-ofile gdb.apple/fix-and-continue \
	gdb.apple/fix-and-continue/small-c \
	gdb.apple/fix-and-continue/small-objc gdb.apple/gused gdb.apple/ld-r \
	gdb.apple/xcode gdb.arch gdb.asm gdb.base gdb.cp gdb.disasm gdb.dwarf2 \
	gdb.fortran gdb.gdb gdb.gdbtk gdb.hp gdb.hp/gdb.aCC gdb.hp/gdb.base-hp \
	gdb.hp/gdb.compat gdb.hp/gdb.defects gdb.hp/gdb.objdbg \
	gdb.hp/gdb.objdbg/objdbg01 gdb.hp/gdb.objdbg/objdbg02 \
	gdb.hp/gdb.objdbg/objdbg03 gdb.hp/gdb.objdbg/objdbg04 \
	gdb.hp/gdb.objdbg/tools gdb.hp/gdb.threads-hp gdb.hp/tools gdb.java \
	gdb.mi gdb.server gdb.stabs gdb.threads gdb.trace

###

site.exp:
	@echo "Making a new config file..."
	-@rm -f ./tmp?
	@touch site.exp
	-@mv site.exp site.bak
	@echo "## these variables are automatically generated by make ##" > ./tmp0
	@echo "# Do not edit here. If you wish to override these values" >> ./tmp0
	@echo "# add them to the last section" >> ./tmp0
	@echo "set host_alias $(host)" >> ./tmp0
	@echo "set host_triplet ${host}" >> ./tmp0
	@echo "set target_alias $(target)" >> ./tmp0
	@echo "set target_triplet ${target}" >> ./tmp0
	@echo "set build_triplet ${build}" >> ./tmp0
	@echo "set srcdir ${srcdir}/gdb" >> ./tmp0
	@echo "set tmpdir ${objdir}" >> ./tmp0
	@echo "set tool gdb" >> ./tmp0
	@echo "## All variables above are generated by configure. Do Not Edit ##" >> ./tmp0
		@cat ./tmp0 > site.exp
	@cat site.bak | sed \
			-e '1,/^## All variables above are.*##/ d' >> site.exp
	-@rm -f ./tmp?
.PHONY: site.exp

make-test-directories: $(TEST_DIRECTORIES:%=$(objdir)/%/.dir)
	@true
.PHONY: make-test-directories

check: ${objdir}/.dir make-test-directories site.exp
	@cp site.exp ${objdir}/$*
	(cd ${objdir}/$* && \
	 env $(ENV_FLAGS) $(RUNTEST) $(RUNTESTFLAGS); \
         python ../filter.py ../expected_results/clang-x86_64-darwin10 < gdb.sum > filtered.gdb.sum)
.PHONY: check

clean:
	rm -rf obj site.exp site.bak *~
.PHONY: clean

%/.dir:
	@mkdir -p $* > /dev/null
	@echo "Created." > $@
.PRECIOUS: %/.dir
